---
title:  "(UNDER CONSTRUCTION) Exploit Development: Windows Kernel Exploitation Part 1 - Debugging Environment and Stack Overflow"
date:   2019-09-21
tags: [posts]
excerpt: "An introduction to creating a kernel debugging environment with WinDbg and IDA to analyze and exploit a vulnerable kernel driver."
---
Introduction
---
As I am currently preparing for Offensive Security's [Advanced Windows Exploitation](https://www.offensive-security.com/documentation/advanced-windows-exploitation.pdf) course, I realized I had a disconnect with some prerequisite knowledge needed to succeed in the course (and in my personal exploit development growth). Among those topics, was kernel exploitation in a Windows environment. A professor, whom I am very close with, once explained to me many moons ago about kernel debugging. He explained it was done remotely, instead of locally (which is what I currently had experience with up until this point). Up until now, that was the only knowledge I had about anything related to the kernel.

Today, I just wanted to document a few things I have done in preparation for the AWE course coming up this year at BlackHat (where I will opefully get a seat). Among these are: how to use WinDbg at a high level (I have experience with WinDbg, but I want to get better, as this is what is used in the AWE course), how to use IDA freeware at a high level (reasoning is synonymous with WinDbg explanation), and how to exploit a vulnerable Windows kernel driver. 

The vulnerable driver I will be analyzing and exploiting today is from the HackSysExtreme team, with their [HackSysExtreme Vulnerable Driver](https://github.com/hacksysteam/HackSysExtremeVulnerableDriver) (HEVD). I cannot stress enough how much HackSysExtreme has done for vulnerability researchers. With that said, let's get into the debugging environment setup.

Setting up the Debugging Environment
---
For our purposes, we will need four things:

1. Windows 7 32-bit VM (need a 32-bit OS)
2. [WinDbg](https://www.microsoft.com/en-us/download/details.aspx?id=8279) (our debugger for remote kernel debugging. Just install the debugging tools.)
3. [IDA freeware](https://www.scummvm.org/news/20180331/) (for disassembly and analyzing the vulnerability)
4. [OSRLOADER](https://www.osronline.com/OsrDown.cfm/osrloaderv30.zip) (for loading the driver)

I will chaining this blog post with future posts to create a series on the other various kernel exploitation methods HEVD provides us to practice with. Eventually, that means 64-bit exploitation will be in future blogs. In the meantime, we have to learn to walk before we can run.

Once the Windows 7 VM has been installed, we need to configure it for debugging. Firstly, we will need to create an environmental variable for the OS itself. Documentation is found [here](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/symbol-path)(scroll down to the _Controlling the Sybmol Path_ section to see more). This variable is created so symbols can be resolved globally (as far as I can tell).

To get to the variable editor, select __Start__ > right click on __Computer__ and select __Properties__ > __Advanced system settings__ > __Environmental Variables__ > __System variables__. Select __New__:

Enter a __Variable name__ of: `_NT_SYMBOL_PATH`

Enter a __Variable value__ of: `SRV*C:\Symbols*https://msdl.microsoft.com/download/symbols`

<img src="{{ site.url }}{{ site.baseurl }}/images/HEVD_1.png" alt="">

Next, we will use a tool within Windows known as [BCDEdit](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/bcdedit-command-line-options). BCDEdit is used to perform action such as: creating or modifying stores that are used to describe boot settings and maipulating boot menu options. We will be doing this, so the machine we will be analyzing (known as the Debugee) can be booted into kernel debugging mode, so analysis can be performed on the WinDbg machien (the Debugger).

Open __cmd.exe__ as Adminstrator, and replicate the following commands:

```terminal
bcdedit.exe /copy {current} /d "HEVD"
bcdedit.exe /debug {VALUE_FROM_ABOVE_COMMAND_SEE_IMAGES_BELOW_} on
bcdedit.exe /dbgsettings
```

<img src="{{ site.url }}{{ site.baseurl }}/images/HEVD_2.png" alt="">
This will make a copy of a specified boot entry.

<img src="{{ site.url }}{{ site.baseurl }}/images/HEVD_3.png" alt="">
This enables kernel debugging for the specified boot entry mentioned above.

<img src="{{ site.url }}{{ site.baseurl }}/images/HEVD_4.png" alt="">
This displays the global debugger settings for the system.

Essentially, this enables kernel debugging over a serial port (virtual serial port in our case).
